<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR Demo</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            z-index: 100;
        }

        #info h1 {
            margin: 0 0 20px 0;
            font-size: 2rem;
        }

        #info p {
            margin: 15px 0;
            line-height: 1.6;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        button, .btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        button:hover, .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #ar-button {
            display: none;
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 20px 40px;
            font-size: 1.2rem;
            z-index: 100;
        }

        .warning {
            background: rgba(255, 152, 0, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>WebXR AR Demo</h1>
        <p>Experience augmented reality directly in your browser!</p>
        <p><strong>Requirements:</strong></p>
        <p>üì± AR-compatible device (Android with ARCore)</p>
        <p>üåê Chrome or Edge browser</p>
        <p>üîí HTTPS connection</p>

        <div id="ar-status">
            <p>Checking AR support...</p>
        </div>

        <div class="btn-group">
            <button id="start-ar" disabled>Start AR</button>
            <a href="../demo-index.html" class="btn">‚Üê Back</a>
        </div>
    </div>

    <button id="ar-button">Tap to place object</button>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';

        let camera, scene, renderer;
        let controller, reticle;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let placedObjects = [];

        const statusDiv = document.getElementById('ar-status');
        const startButton = document.getElementById('start-ar');
        const arButton = document.getElementById('ar-button');

        // Check WebXR support
        async function checkARSupport() {
            if (navigator.xr) {
                const isSupported = await navigator.xr.isSessionSupported('immersive-ar');

                if (isSupported) {
                    statusDiv.innerHTML = '<p style="color: #4CAF50;">‚úì AR is supported on this device!</p>';
                    startButton.disabled = false;
                } else {
                    statusDiv.innerHTML = `
                        <div class="warning">
                            <p>‚ö†Ô∏è AR is not supported on this device.</p>
                            <p>Try opening this on an Android device with Chrome.</p>
                        </div>
                    `;
                }
            } else {
                statusDiv.innerHTML = `
                    <div class="warning">
                        <p>‚ö†Ô∏è WebXR is not available.</p>
                        <p>Make sure you're using HTTPS and a compatible browser.</p>
                    </div>
                `;
            }
        }

        function init() {
            // Scene setup
            scene = new THREE.Scene();

            // Camera setup
            camera = new THREE.PerspectiveCamera(
                70,
                window.innerWidth / window.innerHeight,
                0.01,
                20
            );

            // Lighting
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Create reticle (placement indicator)
            const geometry = new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
            reticle = new THREE.Mesh(geometry, material);
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // Controller for placing objects
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onSelect() {
            if (reticle.visible) {
                // Create a random colored cube or sphere
                const geometries = [
                    new THREE.BoxGeometry(0.2, 0.2, 0.2),
                    new THREE.SphereGeometry(0.1, 32, 32),
                    new THREE.ConeGeometry(0.1, 0.2, 32)
                ];

                const geometry = geometries[Math.floor(Math.random() * geometries.length)];
                const material = new THREE.MeshStandardMaterial({
                    color: Math.random() * 0xffffff,
                    roughness: 0.4,
                    metalness: 0.6
                });

                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.setFromMatrixPosition(reticle.matrix);
                mesh.quaternion.setFromRotationMatrix(reticle.matrix);

                scene.add(mesh);
                placedObjects.push(mesh);

                // Add animation
                mesh.userData.startY = mesh.position.y;
                mesh.userData.time = 0;
            }
        }

        function onSessionStarted(session) {
            session.addEventListener('end', onSessionEnded);

            renderer.xr.setSession(session);
            arButton.style.display = 'block';
            document.getElementById('info').style.display = 'none';

            session.requestReferenceSpace('viewer').then((referenceSpace) => {
                session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                    hitTestSource = source;
                });
            });
        }

        function onSessionEnded() {
            hitTestSource = null;
            hitTestSourceRequested = false;
            arButton.style.display = 'none';
            document.getElementById('info').style.display = 'block';

            // Clean up placed objects
            placedObjects.forEach(obj => scene.remove(obj));
            placedObjects = [];
        }

        startButton.addEventListener('click', async () => {
            const sessionInit = {
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'],
                domOverlay: { root: document.body }
            };

            try {
                const session = await navigator.xr.requestSession('immersive-ar', sessionInit);
                onSessionStarted(session);
            } catch (error) {
                console.error('Failed to start AR session:', error);
                alert('Failed to start AR session. Make sure you granted camera permissions.');
            }
        });

        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render(timestamp, frame) {
            if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (hitTestSourceRequested === false) {
                    session.requestReferenceSpace('viewer').then((referenceSpace) => {
                        session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                            hitTestSource = source;
                        });
                    });

                    hitTestSourceRequested = true;
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);

                    if (hitTestResults.length) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                    } else {
                        reticle.visible = false;
                    }
                }

                // Animate placed objects
                placedObjects.forEach((obj) => {
                    obj.userData.time += 0.016;
                    obj.position.y = obj.userData.startY + Math.sin(obj.userData.time * 2) * 0.02;
                    obj.rotation.y += 0.01;
                });
            }

            renderer.render(scene, camera);
        }

        // Initialize
        checkARSupport();
        init();
        animate();
    </script>
</body>
</html>
